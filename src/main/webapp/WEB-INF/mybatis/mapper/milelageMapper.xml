<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="milelage">

	<select id="selectMilelage" resultType="com.hotbody.milelage.Milelage"
		parameterType="String">

		select nvl(count(rnum),0) orderCount,sum(milelage) totalMilelage,sum(milelagePay) usedMilelage
		,(sum(milelage)-sum(milelagePay))useableMilelage
		from(
		select rownum rnum,ml.milelage,o.milelagePay
		from milelage ml left outer join orders o
		on ml.delorder = o.delorder
		where o.userId=#{userId}
		)
	</select>
	
	
<select id="listMilelage" parameterType="map" resultType="com.hotbody.milelage.Milelage">
	
	 SELECT * FROM (
		SELECT ROWNUM rnum, tb.* FROM (
      select ml.milelage,o.TOTALPAY, TO_CHAR(tl.PAYDATE, 'YYYY-MM-DD') PAYDATE,pl.PDBOARDNAME,o.milelagePay
        from orders o
        left outer join totalordlist tl on o.delorder = tl.delorder
        left outer join cartlist ctl   on o.delorder = ctl.delorder
        left outer join productlist pl on ctl.pdnum = pl.pdnum
        left outer join pmainimg pm  on pm.pdnum = pl.pdnum
        left outer join milelage ml   on o.delorder = ml.delorder
        where
         o.userId=#{userId} and
        <![CDATA[
        TO_CHAR(tl.PAYDATE, 'YYYY-MM-DD') <= #{today} and  TO_CHAR(PAYDATE, 'YYYY-MM-DD')>= #{lastday}

		ORDER BY tl.PAYDATE DESC

	        ) tb WHERE ROWNUM <= #{end}
	    ) WHERE rnum >= #{start}
	]]>
	
	
	</select>
	

</mapper>